<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì˜¤ë°œë ˆ ì•„ì¹´ë°ë¯¸ - ë³´ê°• ìˆ˜ì—… ì‹ ì²­</title>
<link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--gold:#C4A882;--gold-dark:#A8896A;--bg:#FAF8F5;--bg2:#F3EDE4;--text:#3D3428;--text2:#6B5D4E;--muted:#A09080;--border:#EDE5D8;--white:#fff;--green:#16A34A;--green-bg:#F0FAF0;--red:#DC2626;--red-bg:#FEF2F2;--orange:#EA580C;--orange-bg:#FFF7ED}
body{font-family:'Pretendard',sans-serif;background:linear-gradient(168deg,var(--bg) 0%,var(--bg2) 40%,#EDE5D8 100%);min-height:100vh;color:var(--text);-webkit-font-smoothing:antialiased}
.ct{max-width:480px;margin:0 auto;padding:0 16px}
.header{text-align:center;padding:40px 0 24px;border-bottom:1px solid #E8DDD0;margin-bottom:24px}
.header-inner{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px}
.header h1{font-size:22px;font-weight:700;letter-spacing:-0.5px}
.header p{font-size:14px;color:var(--muted);letter-spacing:1px}
.card{background:var(--white);border-radius:18px;padding:24px;border:1px solid var(--border);box-shadow:0 2px 12px rgba(0,0,0,.04);margin-bottom:16px}
.card-c{text-align:center;padding:32px 24px}
.fg{margin-bottom:16px}
.fl{font-size:13px;font-weight:500;color:var(--text2);margin-bottom:6px;display:block}
.inp{width:100%;padding:14px 16px;border:1.5px solid #E0D5C5;border-radius:12px;font-size:15px;background:var(--white);transition:.25s;font-family:inherit;color:var(--text)}
.inp:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px rgba(196,168,130,.15)}
.inp::placeholder{color:#BEB0A0}
.btn-p{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:#fff;border:none;padding:14px 32px;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;transition:.25s;width:100%;font-family:inherit}
.btn-p:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(196,168,130,.4)}
.btn-p:disabled{opacity:.4;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.btn-s{background:var(--white);color:#8B7355;border:1.5px solid #D4C5B0;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:500;cursor:pointer;transition:.25s;font-family:inherit}
.btn-s:hover{background:var(--bg);border-color:var(--gold)}
.btn-r{display:flex;gap:10px}.btn-f1{flex:1}.btn-f2{flex:2}
.btn-back{background:var(--white);border:1.5px solid #E0D5C5;border-radius:10px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:#8B7355;flex-shrink:0}
.tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
.t-y{background:#FED7AA;color:#EA580C}.t-e{background:#BFDBFE;color:#2563EB}.t-a{background:#DDD6FE;color:#7C3AED}
.t-ok{background:var(--green-bg);color:var(--green)}.t-full{background:#FEE2E2;color:var(--red)}
.ig{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.ib{background:var(--bg);border-radius:10px;padding:12px 14px}
.il{font-size:11px;color:var(--muted);margin-bottom:4px}
.iv{font-size:15px;font-weight:600}.ivs{font-size:13px;font-weight:500}
.mb{border-radius:12px;padding:16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.mb.ok{background:var(--green-bg);border:1px solid #BBF7D0}
.mb.no{background:var(--red-bg);border:1px solid #FECACA}
.mc{font-size:28px;font-weight:700}.mc.g{color:var(--green)}.mc.r{color:var(--red)}
.cal{background:var(--white);border-radius:18px;border:1px solid var(--border);overflow:hidden;margin-bottom:16px}
.cal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--bg)}
.cal-header h3{font-size:16px;font-weight:700}
.cal-nav{background:none;border:1.5px solid #D4C5B0;border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:16px;color:#8B7355;display:flex;align-items:center;justify-content:center}
.cal-nav:hover{background:var(--white)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);padding:8px}
.cal-dow{text-align:center;font-size:11px;font-weight:600;color:var(--muted);padding:8px 0}
.cal-dow:first-child{color:#DC2626}
.cal-day{text-align:center;padding:6px 2px;cursor:default;position:relative}
.cal-day .num{width:36px;height:36px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:500;color:var(--text2);transition:.2s}
.cal-day.today .num{font-weight:700;color:var(--text)}
.cal-day.outside .num{color:#D4C5B0}
.cal-day.has-class .num{background:#E8F5E9;color:var(--green);cursor:pointer;font-weight:600}
.cal-day.has-class .num:hover{background:#C8E6C9;transform:scale(1.1)}
.cal-day.has-absence .num{background:#FFCDD2;color:var(--red);cursor:pointer;font-weight:600}
.cal-day.has-makeup .num{background:#E8EAF6;color:#5C6BC0;cursor:pointer;font-weight:600}
.cal-day.selected .num{background:var(--gold)!important;color:var(--white)!important;transform:scale(1.1)}
.cal-day.past .num{color:#D4C5B0!important;background:transparent!important;cursor:not-allowed!important}
.cal-dots{display:flex;justify-content:center;gap:3px;margin-top:2px;height:6px}
.cal-dot{width:5px;height:5px;border-radius:50%}
.cal-dot.cls{background:var(--green)}.cal-dot.abs{background:var(--red)}.cal-dot.mkp{background:#5C6BC0}
.legend{display:flex;gap:16px;justify-content:center;padding:12px;font-size:11px;color:var(--muted)}
.legend-item{display:flex;align-items:center;gap:4px}
.sc{background:var(--white);border-radius:14px;padding:18px;border:1.5px solid var(--border);cursor:pointer;transition:.25s;margin-bottom:10px}
.sc:hover:not(.full):not(.sel){border-color:var(--gold);transform:translateY(-1px)}
.sc.sel{border-color:var(--gold);background:#FBF8F4;box-shadow:0 4px 15px rgba(196,168,130,.2)}
.sc.full{opacity:.5;cursor:not-allowed}
.sc-top{display:flex;justify-content:space-between;align-items:flex-start}
.sc-tags{display:flex;gap:8px;margin-bottom:8px}
.sc-time{font-size:18px;font-weight:700}.sc-time.m{color:#BEB0A0}
.chk{width:22px;height:22px;border-radius:50%;border:2px solid #D4C5B0;display:flex;align-items:center;justify-content:center;transition:.2s}
.chk.on{background:var(--gold);border-color:var(--gold)}
.spots{font-size:12px;font-weight:600}.spots.g{color:var(--green)}.spots.o{color:var(--orange)}.spots.r{color:var(--red)}
.cap-bar{height:6px;border-radius:3px;background:var(--border);overflow:hidden;margin-top:10px}
.cap-fill{height:100%;border-radius:3px;transition:width .4s}
.err{background:var(--red-bg);border:1px solid #FECACA;border-radius:10px;padding:12px 14px;margin-bottom:20px;font-size:13px;color:var(--red);line-height:1.5}
.loading{display:flex;align-items:center;justify-content:center;gap:10px;padding:40px;color:var(--muted);font-size:14px}
.spinner{width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.notice{background:var(--orange-bg);border-radius:12px;padding:14px 16px;margin-bottom:16px;text-align:left}
.notice p{font-size:13px;color:var(--orange);line-height:1.6}
.fade{animation:fadeIn .4s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.footer{text-align:center;padding:32px 0 40px;font-size:11px;color:#C4B8A8;line-height:1.8}
.tabs{display:flex;border-radius:12px;overflow:hidden;border:1.5px solid var(--border);margin-bottom:16px}
.tab{flex:1;padding:12px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;transition:.2s;background:var(--white);color:var(--muted);font-family:inherit;border:none}
.tab.active{background:var(--text);color:var(--white)}
.tab:not(.active):hover{background:var(--bg)}
.confirm-d{background:var(--bg);border-radius:14px;padding:20px;text-align:left;margin-bottom:28px}
.confirm-r{display:flex;justify-content:space-between;margin-bottom:14px}
.confirm-r:last-child{margin-bottom:0}
.sticky{position:sticky;bottom:0;padding:12px 0 24px;background:linear-gradient(0deg,var(--bg2) 60%,transparent)}
.booking-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
.booking-item+.booking-item{border-top:1px solid #F3EDE4}
.abs-warn{background:#FFF3E0;border:1px solid #FFE0B2;border-radius:12px;padding:16px;margin-bottom:16px;text-align:center}
.abs-warn p{font-size:13px;color:var(--orange);line-height:1.6}
.done-icon{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:32px}
h2{font-size:17px;font-weight:600;margin-bottom:6px}
h3{font-size:14px;font-weight:600;margin-bottom:12px}
</style>
</head>
<body>
<div class="ct">
  <div class="header">
    <div class="header-inner">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="15" stroke="#C4A882" stroke-width="1.5"/><ellipse cx="16" cy="14" rx="4" ry="6" stroke="#C4A882" stroke-width="1.2"/><path d="M12 20 Q16 26 20 20" stroke="#C4A882" stroke-width="1.2"/><line x1="16" y1="8" x2="16" y2="6" stroke="#C4A882"/><circle cx="16" cy="5" r="1.5" fill="#C4A882"/></svg>
      <h1>ì˜¤ë°œë ˆ ì•„ì¹´ë°ë¯¸</h1>
    </div>
    <p>ë³´ê°• ìˆ˜ì—… ì‹ ì²­</p>
  </div>
  <div id="content"></div>
  <div class="footer">ì˜¤ë°œë ˆ ì•„ì¹´ë°ë¯¸ Â· ë³´ê°• ìˆ˜ì—… ì˜ˆì•½ ì‹œìŠ¤í…œ<br>ë¬¸ì˜: í•™ì› ëŒ€í‘œë²ˆí˜¸</div>
</div>
<script>
// â˜…â˜…â˜… ë³¸ì¸ì˜ Google Apps Script ì›¹ì•± URLë¡œ ë³€ê²½í•˜ì„¸ìš” â˜…â˜…â˜…
const API_URL = 'https://script.google.com/macros/s/AKfycbxvRPV-vUji9z24hognx_oVHpFAXtAtJ6mRW9_qUDzVAO5TTYK8pSjYUmJ6wnTcR59n/exec';

let S={step:'login',name:'',studentId:'',student:null,allSchedules:[],bookings:[],absences:[],selectedDate:null,selectedSchedule:null,mode:'absence',calYear:new Date().getFullYear(),calMonth:new Date().getMonth(),error:'',loading:false};

function tc(cn){return cn.startsWith('ìœ ì•„')?'t-y':cn.startsWith('ì´ˆë“±')?'t-e':'t-a'}

async function api(p){
  const u=new URL(API_URL);
  Object.keys(p).forEach(k=>u.searchParams.append(k,p[k]));
  try{const r=await fetch(u);return await r.json();}catch(e){return{success:false,error:'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'};}
}

function parseSchedule(str){
  if(!str)return[];
  const dm={'ì¼':0,'ì›”':1,'í™”':2,'ìˆ˜':3,'ëª©':4,'ê¸ˆ':5,'í† ':6};
  const result=[];
  str.split('/').map(s=>s.trim()).forEach(p=>{
    const m=p.match(/^([ê°€-í£,\s]+)\s+(\d{1,2}:\d{2})$/);
    if(m){m[1].split(',').map(d=>d.trim()).forEach(d=>{if(dm[d]!==undefined)result.push({day:d,dayNum:dm[d],time:m[2]})});}
  });
  return result;
}

function dn(d){return['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][d.getDay()]}
function shortDate(ds){const d=new Date(ds);return`${d.getMonth()+1}/${d.getDate()}(${dn(d)})`}
function fmt(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}

// Get schedules for a specific date from local cache
function getSchedulesForDate(date){return S.allSchedules.filter(s=>s.date===date);}

// Get month summary from local cache
function getMonthSummary(y,m){
  const prefix=`${y}-${String(m+1).padStart(2,'0')}`;
  const summary={};
  S.allSchedules.filter(s=>s.date.startsWith(prefix)).forEach(s=>{
    if(!summary[s.date])summary[s.date]={total:0,available:0};
    summary[s.date].total++;
    if(!s.isFull)summary[s.date].available++;
  });
  return summary;
}

function render(){
  const el=document.getElementById('content');
  switch(S.step){
    case'login':el.innerHTML=renderLogin();break;
    case'main':el.innerHTML=renderMain();break;
    case'daySchedules':el.innerHTML=renderDaySchedules();break;
    case'confirmAbsence':el.innerHTML=renderConfirmAbsence();break;
    case'confirmBook':el.innerHTML=renderConfirmBook();break;
    case'doneAbsence':el.innerHTML=renderDoneAbsence();break;
    case'doneBook':el.innerHTML=renderDoneBook();break;
  }
  bind();
}

function renderLogin(){
  return`<div class="card card-c fade"><h2>ë³¸ì¸ í™•ì¸</h2><p style="font-size:13px;color:var(--muted);margin-bottom:24px">ë“±ë¡ ì‹œ ì•ˆë‚´ë°›ì€ ì´ë¦„ê³¼ ì¶œê²°ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
  <div class="fg"><label class="fl">ì´ë¦„</label><input class="inp" id="iName" placeholder="í™ê¸¸ë™" value="${S.name}"></div>
  <div class="fg" style="margin-bottom:24px"><label class="fl">ì¶œê²°ë²ˆí˜¸</label><input class="inp" id="iId" placeholder="A001" value="${S.studentId}" style="text-transform:uppercase"></div>
  ${S.error?`<div class="err">${S.error}</div>`:''}
  <button class="btn-p" id="btnLogin" ${S.loading?'disabled':''}>${S.loading?'<span class="spinner" style="display:inline-block;width:16px;height:16px;border-width:2px;vertical-align:middle;margin-right:8px"></span>ì¡°íšŒ ì¤‘...':'ì¡°íšŒí•˜ê¸°'}</button></div>
  <p style="text-align:center;font-size:12px;color:#BEB0A0;margin-top:20px">ì¶œê²°ë²ˆí˜¸ë¥¼ ëª¨ë¥´ì‹œë©´ í•™ì›ìœ¼ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>`;
}

function renderMain(){
  const s=S.student,rem=s.remainingMakeup;
  const calHtml=renderCalendar();
  let histHtml='';
  const absItems=S.absences.filter(a=>a.status==='í™•ì •').map(a=>`<div class="booking-item"><span style="font-size:13px;font-weight:500">${shortDate(a.absenceDate)} Â· ${S.student.class} Â· ${a.time}</span><span class="tag t-full">ê²°ì„</span></div>`).join('');
  const bkItems=S.bookings.filter(b=>b.status==='í™•ì •').map(b=>`<div class="booking-item"><span style="font-size:13px;font-weight:500">${shortDate(b.bookingDate)} Â· ${b.className} Â· ${b.time}</span><span class="tag t-ok">ë³´ê°•</span></div>`).join('');
  if(absItems||bkItems)histHtml=`<div class="card" style="padding:20px 24px"><h3>ì‹ ì²­ ë‚´ì—­</h3>${absItems}${bkItems}</div>`;

  return`<div class="fade">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
      <div><h2 style="font-size:20px;margin-bottom:2px">${s.name}</h2><p style="font-size:13px;color:var(--muted)">${s.id} Â· ${s.class}</p></div>
      <span class="tag ${tc(s.class)}">${s.planType}</span>
    </div>
    <div class="ig">
      <div class="ib"><p class="il">ë“±ë¡ ê¸°ê°„</p><p class="ivs">${s.startDate.slice(5)} ~ ${s.endDate.slice(5)}</p></div>
      <div class="ib"><p class="il">ì •ê·œ ìˆ˜ì—…</p><p class="ivs">${s.regularSchedule}</p></div>
    </div>
    <div class="ig">
      <div class="mb ${rem>0?'ok':'no'}" style="margin:0"><div><span style="font-size:13px">ë³´ê°• ì”ì—¬</span></div><div style="display:flex;align-items:baseline;gap:4px"><span class="mc ${rem>0?'g':'r'}">${rem}</span><span style="font-size:13px;color:var(--muted)">/${s.maxMakeup}íšŒ</span></div></div>
      <div class="mb ok" style="margin:0;background:#FFF3E0;border-color:#FFE0B2"><div><span style="font-size:13px">ê²°ì„ ì‹ ê³ </span></div><div><span class="mc" style="color:var(--orange)">${s.absenceCount}</span><span style="font-size:13px;color:var(--muted)">íšŒ</span></div></div>
    </div>
  </div>
  <div class="tabs">
    <button class="tab ${S.mode==='absence'?'active':''}" data-mode="absence">ğŸ“… ê²°ì„ ì‹ ê³ </button>
    <button class="tab ${S.mode==='makeup'?'active':''}" data-mode="makeup">âœï¸ ë³´ê°• ì‹ ì²­</button>
  </div>
  ${S.mode==='makeup'&&s.absenceCount===0?'<div class="abs-warn"><p>âš ï¸ ê²°ì„ ì‹ ê³ ë¥¼ ë¨¼ì € í•´ì£¼ì„¸ìš”.<br>ê²°ì„ ì‹ ê³  í›„ ë³´ê°• ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p></div>':''}
  ${S.mode==='makeup'&&s.absenceCount>0&&rem<=0?'<div class="abs-warn"><p>âš ï¸ ë³´ê°• ê°€ëŠ¥ íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.<br>ì¶”ê°€ ë³´ê°•ì„ ì›í•˜ì‹œë©´ ê²°ì„ ì‹ ê³ ë¥¼ ë¨¼ì € í•´ì£¼ì„¸ìš”.</p></div>':''}
  ${calHtml}${histHtml}
  <button class="btn-s" id="btnLogout" style="width:100%">ë¡œê·¸ì•„ì›ƒ</button></div>`;
}

function renderCalendar(){
  const y=S.calYear,m=S.calMonth,fd=new Date(y,m,1).getDay(),dim=new Date(y,m+1,0).getDate();
  const today=new Date();today.setHours(0,0,0,0);
  const sched=parseSchedule(S.student?.regularSchedule||'');
  const sd=new Date(S.student.startDate),ed=new Date(S.student.endDate);
  const ms=S.mode==='makeup'?getMonthSummary(y,m):{};
  const mn=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  let c='';
  ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach((d,i)=>{c+=`<div class="cal-dow"${i===0?' style="color:#DC2626"':''}>${d}</div>`;});
  for(let i=0;i<fd;i++)c+=`<div class="cal-day outside"><span class="num"></span></div>`;
  for(let d=1;d<=dim;d++){
    const dt=new Date(y,m,d),ds=fmt(dt),wd=dt.getDay(),isPast=dt<today,inR=dt>=sd&&dt<=ed;
    const hasClass=sched.some(s=>s.dayNum===wd)&&inR&&S.allSchedules.some(s=>s.date===ds);
    const hasAbs=S.absences.some(a=>a.absenceDate===ds&&a.status==='í™•ì •');
    const hasMkp=S.bookings.some(b=>b.bookingDate===ds&&b.status==='í™•ì •');
    const hasAvail=ms[ds]&&ms[ds].available>0;
    const isSel=S.selectedDate===ds;
    let cls='cal-day';
    if(dt.toDateString()===today.toDateString())cls+=' today';
    if(!inR)cls+=' outside';
    if(isPast)cls+=' past';
    if(isSel)cls+=' selected';
    if(S.mode==='absence'){if(hasAbs)cls+=' has-absence';else if(hasClass&&!isPast&&inR)cls+=' has-class';}
    else{if(hasMkp)cls+=' has-makeup';else if(hasAvail&&!isPast&&inR)cls+=' has-class';}
    let ok=false;
    if(S.mode==='absence'&&hasClass&&!isPast&&inR&&!hasAbs)ok=true;
    if(S.mode==='makeup'&&hasAvail&&!isPast&&inR&&!hasMkp&&S.student.absenceCount>0&&S.student.remainingMakeup>0)ok=true;
    let dots='';
    if(hasAbs)dots+='<div class="cal-dot abs"></div>';
    if(hasMkp)dots+='<div class="cal-dot mkp"></div>';
    if(hasClass&&!hasAbs&&S.mode==='absence')dots+='<div class="cal-dot cls"></div>';
    c+=`<div class="${cls}"${ok?` data-date="${ds}"`:''} ><span class="num">${d}</span><div class="cal-dots">${dots}</div></div>`;
  }
  return`<div class="cal"><div class="cal-header"><button class="cal-nav" id="calPrev">â€¹</button><h3>${y}ë…„ ${mn[m]}</h3><button class="cal-nav" id="calNext">â€º</button></div><div class="cal-grid">${c}</div>
  <div class="legend"><div class="legend-item"><div class="cal-dot cls"></div>${S.mode==='absence'?'ë‚´ ìˆ˜ì—…ì¼':'ë³´ê°• ê°€ëŠ¥'}</div><div class="legend-item"><div class="cal-dot abs"></div>ê²°ì„ ì‹ ê³ </div><div class="legend-item"><div class="cal-dot mkp"></div>ë³´ê°• ì‹ ì²­</div></div></div>`;
}

function renderDaySchedules(){
  const date=S.selectedDate,dayName=dn(new Date(date));
  const scheds=getSchedulesForDate(date);
  const cards=scheds.map(sc=>{
    const isFull=sc.isFull,isSel=S.selectedSchedule&&S.selectedSchedule.id===sc.id;
    const spots=sc.remaining,pct=(sc.enrolled/sc.capacity)*100;
    const sCls=isFull?'r':spots<=2?'o':'g';
    return`<div class="sc ${isFull?'full':''} ${isSel?'sel':''}" data-sid="${sc.id}">
      <div class="sc-top"><div style="flex:1"><div class="sc-tags"><span class="tag ${tc(sc.className)}">${sc.className}</span>${isFull?'<span class="tag t-full">ë§ˆê°</span>':''}</div><span class="sc-time ${isFull?'m':''}">${sc.time}</span></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px"><div class="chk ${isSel?'on':''}">${isSel?'<span style="color:#fff;font-size:14px">âœ“</span>':''}</div><span class="spots ${sCls}">${isFull?'0ì„':`ì”ì—¬ ${spots}ì„`}</span></div></div>
      <div class="cap-bar"><div class="cap-fill" style="width:${pct}%;background:${isFull?'#F87171':pct>70?'#FB923C':'#86EFAC'}"></div></div></div>`;
  }).join('');
  return`<div class="fade"><div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><button class="btn-back" id="btnBackMain">â†</button><div><h2>${date} (${dayName})</h2><p style="font-size:12px;color:var(--muted)">ë³´ê°• ê°€ëŠ¥í•œ ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p></div></div>
  ${scheds.length===0?'<div class="loading">í•´ë‹¹ ë‚ ì§œì— ë³´ê°• ê°€ëŠ¥í•œ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>':cards}
  <div class="sticky"><button class="btn-p" id="btnGoConfirmBook" ${!S.selectedSchedule?'disabled':''}>${S.selectedSchedule?`${S.selectedSchedule.time} ${S.selectedSchedule.className} ì„ íƒ`:'ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”'}</button></div></div>`;
}

function renderConfirmAbsence(){
  const s=S.student,date=S.selectedDate,dayName=dn(new Date(date));
  const sched=parseSchedule(s.regularSchedule),dayNum=new Date(date).getDay();
  const cls=sched.filter(sc=>sc.dayNum===dayNum);
  return`<div class="card card-c fade">
    <div style="width:56px;height:56px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:24px">ğŸ“‹</div>
    <h2 style="font-size:18px;margin-bottom:8px">ê²°ì„ ì‹ ê³  í™•ì¸</h2><p style="font-size:13px;color:var(--muted);margin-bottom:28px">ì•„ë˜ ë‚ ì§œì— ê²°ì„ì„ ì‹ ê³ í•©ë‹ˆë‹¤.</p>
    <div class="confirm-d">
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ì´ë¦„</span><span style="font-size:14px;font-weight:600">${s.name}</span></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ì†Œì†ë°˜</span><span style="font-size:14px;font-weight:500">${s.class}</span></div>
      <div style="height:1px;background:var(--border);margin:4px 0 14px"></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ê²°ì„ ë‚ ì§œ</span><span style="font-size:14px;font-weight:600">${date} (${dayName})</span></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ìˆ˜ì—… ì‹œê°„</span><span style="font-size:14px;font-weight:600">${cls.map(c=>c.time).join(', ')}</span></div>
    </div>
    ${S.error?`<div class="err">${S.error}</div>`:''}
    <div class="btn-r"><button class="btn-s btn-f1" id="btnBackAbs">ë’¤ë¡œ</button><button class="btn-p btn-f2" id="btnConfirmAbs" ${S.loading?'disabled':''}>${S.loading?'ì²˜ë¦¬ ì¤‘...':'ê²°ì„ ì‹ ê³ '}</button></div></div>`;
}

function renderConfirmBook(){
  const s=S.student,sc=S.selectedSchedule,date=S.selectedDate,dayName=dn(new Date(date));
  return`<div class="card card-c fade">
    <div style="width:56px;height:56px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:24px">ğŸ“‹</div>
    <h2 style="font-size:18px;margin-bottom:8px">ë³´ê°• ì‹ ì²­ í™•ì¸</h2><p style="font-size:13px;color:var(--muted);margin-bottom:28px">ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ ë³´ê°•ì„ ì‹ ì²­í•©ë‹ˆë‹¤.</p>
    <div class="confirm-d">
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ì´ë¦„</span><span style="font-size:14px;font-weight:600">${s.name}</span></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ì†Œì†ë°˜</span><span style="font-size:14px;font-weight:500">${s.class}</span></div>
      <div style="height:1px;background:var(--border);margin:4px 0 14px"></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ë³´ê°• ë‚ ì§œ</span><span style="font-size:14px;font-weight:600">${date} (${dayName})</span></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ë³´ê°• ìˆ˜ì—…</span><span style="font-size:14px;font-weight:600;color:var(--gold-dark)">${sc.className}</span></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ìˆ˜ì—… ì‹œê°„</span><span style="font-size:14px;font-weight:600">${sc.time}</span></div>
      <div class="confirm-r"><span style="font-size:13px;color:var(--muted)">ì‹ ì²­ í›„ ì”ì—¬</span><span style="font-size:14px;font-weight:600;color:${s.remainingMakeup-1>0?'var(--green)':'var(--orange)'}">${s.remainingMakeup-1}íšŒ</span></div>
    </div>
    ${S.error?`<div class="err">${S.error}</div>`:''}
    <div class="btn-r"><button class="btn-s btn-f1" id="btnBackBook">ë’¤ë¡œ</button><button class="btn-p btn-f2" id="btnConfirmBook" ${S.loading?'disabled':''}>${S.loading?'ì²˜ë¦¬ ì¤‘...':'ì‹ ì²­ í™•ì •'}</button></div></div>`;
}

function renderDoneAbsence(){
  const date=S.selectedDate,dayName=dn(new Date(date));
  return`<div class="card card-c fade" style="padding:40px 24px"><div class="done-icon" style="background:linear-gradient(135deg,#FFF3E0,#FFE0B2)">ğŸ“Œ</div>
  <h2 style="font-size:20px;margin-bottom:8px">ê²°ì„ ì‹ ê³  ì™„ë£Œ!</h2><p style="font-size:14px;color:var(--muted);margin-bottom:32px;line-height:1.6"><strong style="color:var(--text)">${date} (${dayName})</strong><br>ê²°ì„ì´ ì‹ ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
  <div class="notice"><p>ğŸ’¡ ì´ì œ ë³´ê°• ì‹ ì²­ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤!</p></div>
  <button class="btn-p" id="btnBackToMain">ëŒì•„ê°€ê¸°</button></div>`;
}

function renderDoneBook(){
  const sc=S.selectedSchedule,date=S.selectedDate,dayName=dn(new Date(date));
  return`<div class="card card-c fade" style="padding:40px 24px"><div class="done-icon" style="background:linear-gradient(135deg,var(--green-bg),#DCFCE7)">âœ“</div>
  <h2 style="font-size:20px;margin-bottom:8px">ë³´ê°• ì‹ ì²­ ì™„ë£Œ!</h2><p style="font-size:14px;color:var(--muted);margin-bottom:32px;line-height:1.6">${sc.className}<br><strong style="color:var(--text)">${date} (${dayName}) ${sc.time}</strong><br>ë³´ê°•ì´ ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
  <div class="notice"><p>ğŸ’¡ ì·¨ì†Œê°€ í•„ìš”í•˜ì‹œë©´ í•™ì›ìœ¼ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”.</p></div>
  <button class="btn-p" id="btnBackToMain">ëŒì•„ê°€ê¸°</button></div>`;
}

function bind(){
  document.getElementById('btnLogin')?.addEventListener('click',doLogin);
  document.getElementById('iName')?.addEventListener('input',e=>{S.name=e.target.value});
  document.getElementById('iId')?.addEventListener('input',e=>{S.studentId=e.target.value});
  document.getElementById('iName')?.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
  document.getElementById('iId')?.addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
  document.getElementById('btnLogout')?.addEventListener('click',()=>{S={step:'login',name:'',studentId:'',student:null,allSchedules:[],bookings:[],absences:[],selectedDate:null,selectedSchedule:null,mode:'absence',calYear:new Date().getFullYear(),calMonth:new Date().getMonth(),error:'',loading:false};render();});
  document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{S.mode=t.dataset.mode;S.selectedDate=null;S.error='';render();}));
  document.getElementById('calPrev')?.addEventListener('click',()=>{S.calMonth--;if(S.calMonth<0){S.calMonth=11;S.calYear--;}S.selectedDate=null;render();});
  document.getElementById('calNext')?.addEventListener('click',()=>{S.calMonth++;if(S.calMonth>11){S.calMonth=0;S.calYear++;}S.selectedDate=null;render();});
  document.querySelectorAll('.cal-day[data-date]').forEach(d=>d.addEventListener('click',()=>{
    const date=d.dataset.date;S.selectedDate=date;S.error='';
    if(S.mode==='absence'){S.step='confirmAbsence';render();}
    else{S.step='daySchedules';S.selectedSchedule=null;render();}
  }));
  document.querySelectorAll('.sc:not(.full)').forEach(c=>c.addEventListener('click',()=>{
    const id=c.dataset.sid,sc=S.allSchedules.find(s=>s.id===id);
    S.selectedSchedule=S.selectedSchedule?.id===id?null:sc;render();
  }));
  document.getElementById('btnBackMain')?.addEventListener('click',()=>{S.step='main';S.selectedDate=null;S.selectedSchedule=null;S.error='';render();});
  document.getElementById('btnBackAbs')?.addEventListener('click',()=>{S.step='main';S.error='';render();});
  document.getElementById('btnBackBook')?.addEventListener('click',()=>{S.step='daySchedules';S.error='';render();});
  document.getElementById('btnGoConfirmBook')?.addEventListener('click',()=>{if(S.selectedSchedule){S.step='confirmBook';S.error='';render();}});
  document.getElementById('btnConfirmAbs')?.addEventListener('click',doReportAbsence);
  document.getElementById('btnConfirmBook')?.addEventListener('click',doBook);
  document.getElementById('btnBackToMain')?.addEventListener('click',()=>{S.step='main';S.selectedDate=null;S.selectedSchedule=null;S.error='';render();});
}

// ===== API: ë¡œê·¸ì¸ (1ë²ˆ í˜¸ì¶œë¡œ ì „ë¶€ ë¡œë“œ) =====
async function doLogin(){
  const name=document.getElementById('iName')?.value.trim(),id=document.getElementById('iId')?.value.trim();
  if(!name||!id){S.error='ì´ë¦„ê³¼ ì¶œê²°ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.';render();return;}
  S.name=name;S.studentId=id;S.error='';S.loading=true;render();
  const r=await api({action:'loginFull',name,studentId:id});
  S.loading=false;
  if(!r.success){S.error=r.error;render();return;}
  S.student=r.student;S.absences=r.absences||[];S.bookings=r.bookings||[];S.allSchedules=r.schedules||[];
  const now=new Date();S.calYear=now.getFullYear();S.calMonth=now.getMonth();
  S.step='main';S.mode='absence';S.error='';render();
}

// ===== API: ê²°ì„ ì‹ ê³  (1ë²ˆ í˜¸ì¶œ, ë¡œì»¬ ì—…ë°ì´íŠ¸) =====
async function doReportAbsence(){
  S.loading=true;S.error='';render();
  const sched=parseSchedule(S.student.regularSchedule),dayNum=new Date(S.selectedDate).getDay(),dayName=dn(new Date(S.selectedDate));
  const cls=sched.filter(sc=>sc.dayNum===dayNum);
  let ok=true;
  for(const c of cls){
    const r=await api({action:'reportAbsence',studentId:S.student.id,absenceDate:S.selectedDate,absenceDay:dayName,absenceTime:c.time});
    if(!r.success&&!r.error.includes('ì´ë¯¸')){S.error=r.error;ok=false;break;}
    if(r.success&&r.absence){S.absences.push(r.absence);S.student.absenceCount++;S.student.remainingMakeup=Math.max(0,Math.min(S.student.absenceCount,S.student.maxMakeup)-S.student.usedMakeup);}
  }
  S.loading=false;
  if(ok)S.step='doneAbsence';
  render();
}

// ===== API: ë³´ê°• ì‹ ì²­ (1ë²ˆ í˜¸ì¶œ, ë¡œì»¬ ì—…ë°ì´íŠ¸) =====
async function doBook(){
  S.loading=true;S.error='';render();
  const r=await api({action:'book',studentId:S.student.id,scheduleId:S.selectedSchedule.id});
  S.loading=false;
  if(!r.success){S.error=r.error;render();return;}
  // ë¡œì»¬ ìºì‹œ ì—…ë°ì´íŠ¸
  S.student.remainingMakeup=r.remainingMakeup;
  S.student.usedMakeup=S.student.maxMakeup-r.remainingMakeup;
  S.bookings.push(r.booking);
  if(r.updatedSchedule){
    const idx=S.allSchedules.findIndex(s=>s.id===r.updatedSchedule.id);
    if(idx>=0){S.allSchedules[idx].enrolled=r.updatedSchedule.enrolled;S.allSchedules[idx].remaining=r.updatedSchedule.remaining;S.allSchedules[idx].isFull=r.updatedSchedule.isFull;}
  }
  S.step='doneBook';render();
}

render();
</script>
</body>
</html>
